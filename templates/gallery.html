<!-- templates/gallery.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plant Disease — Dataset Gallery</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1: #eef8f6;
      --bg-2: #f6fbff;
      --card: #ffffff;
      --accent: #0f7a4f;
      --accent-2: #2aa06b;
      --muted: #667085;
      --shadow-md: 0 8px 20px rgba(8,11,15,0.06);
      --shadow-lg: 0 20px 40px rgba(8,11,15,0.08);
      font-family: "Inter", sans-serif;
    }

    body{ margin:0; background:linear-gradient(180deg,var(--bg-1),var(--bg-2)); color:#07331c; }
    .wrap{ max-width:1200px; margin:28px auto; padding:28px; }

    header.hero{
      display:flex; gap:22px; align-items:center; padding:28px;
      border-radius:16px; background:linear-gradient(90deg,rgba(6,50,28,0.08),rgba(20,150,90,0.03));
      box-shadow:var(--shadow-lg);
    }
    .hero .left{ width:120px;height:120px;border-radius:18px;
      background:linear-gradient(160deg,#0f7a4f,#7ad29b);
      display:flex;align-items:center;justify-content:center;color:white;
      box-shadow:0 8px 30px rgba(15,122,79,0.18);
    }
    .hero .left img { width: 70%; height: 70%; object-fit: contain; border-radius: 12px; }
    .hero .right h1{margin:0;font-size:30px;font-weight:800;color:var(--accent);}
    .hero .right p{margin:10px 0 0;font-size:15px;color:var(--muted);max-width:700px;}

    .uploader { margin-top:18px; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .dropzone { flex:1; min-height:64px; border-radius:12px; background:#f2f7f5; border:2px dashed rgba(8,11,15,0.06);
      display:flex; align-items:center; justify-content:space-between; padding:12px 16px; gap:12px; }
    .dropzone.dragover { background:#e6fbf0; border-color:var(--accent-2); }
    .btn { background:var(--accent); color:white; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; text-decoration:none; display:inline-block; }
    .btn.ghost { background:transparent; color:var(--accent); border:1px solid rgba(0,0,0,0.06); }

    /* grid layout: auto-fit with consistent min width */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap:20px;
      margin-top:20px;
      justify-content: start; /* don't stretch single items */
      align-items: start;
    }

    /* CARD: keep size consistent by limiting width */
    .card{
      background: linear-gradient(180deg,#fff,#f8fffa);
      padding: 12px;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      transition: .18s;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      min-height: 180px;
      max-width: 260px;   /* IMPORTANT: prevents full-width stretching */
      width: 100%;        /* allows responsive shrink within column */
      box-sizing: border-box;
    }
    .card:hover{ transform: translateY(-4px); box-shadow: 0 20px 40px rgba(8,11,15,0.12); }

    /* thumbnail container — consistent height */
    .thumb{
      width: 100%;
      height: 110px;     /* consistent height for all thumbs */
      border-radius: 10px;
      overflow: hidden;
      background: #f2f7f5;
      border: 1px solid #e8efec;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .thumb img{
      width: 100%;
      height: 100%;
      object-fit: cover;     /* center-crop, no stretching */
      object-position: center center;
      display: block;
      -webkit-user-drag: none;
    }

    .meta{display:flex;justify-content:space-between;align-items:center;margin-top:10px;}
    .name{font-weight:700;color:#07331c;}
    .sub{font-size:13px;color:var(--muted);}
    .badge{ background:#e7f9ee;color:var(--accent-2);padding:8px 12px;border-radius:999px;font-weight:200;font-size:13px; }
    .card-footer{display:flex;justify-content:space-between;margin-top:12px;}
    .sm-btn{border:0;background:transparent;color:var(--accent);font-weight:700;cursor:pointer;}
    .download{background:var(--accent);color:white;padding:8px 12px;border-radius:10px;font-weight:700;text-decoration:none;}

    /* ensure uploaded gallery uses same layout rules and centers small set */
    #uploadedGallery { justify-items: start; }

    .lightbox{ position:fixed; inset:0; background:rgba(5,10,8,0.80); display:none; align-items:center; justify-content:center; z-index:9999; padding:28px; }
    .frame{ background:#012112; padding:20px; border-radius:12px; max-width:1100px; width:100%; display:flex; flex-direction:column; align-items:center; gap:12px; }
    .frame img{ max-width:98%; max-height:70vh; border-radius:8px; box-shadow:0 25px 60px rgba(0,0,0,0.4); }
    .caption{ color:#d8ffe8; font-weight:700; }
    .close{ border:0; background:transparent; color:white; font-size:22px; cursor:pointer; }

    @media (max-width:700px) {
      .hero { flex-direction:column; align-items:flex-start; }
      .dropzone { flex-direction:column; align-items:flex-start; gap:8px; }
      .card-footer { flex-direction:column; align-items:flex-start; }
      .grid { grid-template-columns: 1fr; justify-content: center; }
      .card { max-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <div class="left"><img src="/static/icon.png" alt="icon" onerror="this.style.opacity=.2"></div>
      <div class="right">
        <h1>Plant Disease — Dataset Gallery</h1>
        <p>Browse dataset images. Preview, download or add your photos to the dataset. Uploaded images are saved separately in the "uploads/" folder.</p>
      </div>
    </header>

    <div class="uploader">
      <div id="dropzone" class="dropzone" aria-label="Drop images here">
        <div style="display:flex;gap:12px;align-items:center">
          <div>
            <div style="font-weight:700;color:#064b33">Drag & drop images here</div>
            <div style="font-size:13px;color:var(--muted)">PNG / JPG / GIF — saved to server uploads/</div>
          </div>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <label class="btn ghost" for="fileInput">Browse files</label>
          <input id="fileInput" style="display:none" type="file" accept="image/*" multiple>
          <button id="uploadBtn" class="btn">Upload to server</button>
        </div>
      </div>

      <div style="min-width:220px;text-align:right">
        <a class="btn" id="downloadAll">Download All (ZIP)</a>
      </div>
    </div>

    <h3 style="margin-top:18px">Dataset images</h3>
    <div class="grid" id="gallery">
      <!-- Cards are injected by JS -->
    </div>

    <h3 style="margin-top:22px">Uploaded images (uploads/)</h3>
    <div class="grid" id="uploadedGallery"></div>
  </div>

  <div class="lightbox" id="lightbox" role="dialog" aria-hidden="true">
    <div class="frame">
      <div style="display:flex;width:100%;justify-content:space-between;">
        <div style="color:white;font-weight:800">Preview</div>
        <button class="close" id="closeBtn" aria-label="Close preview">✕</button>
      </div>
      <img id="lbImg" src="" alt="">
      <div class="caption" id="lbCap"></div>
      <a id="lbDown" class="download" href="#" download>Download</a>
    </div>
  </div>

<script>
  const dataset = {{ dataset_images|tojson }};
  const uploads = {{ uploaded_images|tojson }};

  const galleryEl = document.getElementById('gallery');
  const uploadedEl = document.getElementById('uploadedGallery');

  function makeCard(srcPath, filename) {
    const title = filename.replace(/\.[^/.]+$/, "").replace(/[_-]+/g," ").replace(/\b\w/g,c=>c.toUpperCase());
    const art = document.createElement('article');
    art.className = 'card';
    art.dataset.src = `/images/${filename}`;
    art.dataset.title = title;
    art.dataset.desc = filename;
    art.innerHTML = `
      <div class="thumb"><img src="/images/${filename}" alt="${title}"></div>
      <div class="meta">
        <div>
          <div class="name">${title}</div>
          <div class="sub">${filename}</div>
        </div>
        <div class="badge">—</div>
      </div>
      <div class="card-footer">
        <button class="sm-btn view">Preview</button>
        <a class="download" href="/images/${filename}" download="${filename}">Download</a>
      </div>
    `;
    return art;
  }

  function renderLists() {
    galleryEl.innerHTML = '';
    uploadedEl.innerHTML = '';
    dataset.forEach(fn => galleryEl.appendChild(makeCard(`/images/${fn}`, fn)));
    uploads.forEach(fn => uploadedEl.appendChild(makeCard(`/images/${fn}`, fn)));
  }

  renderLists();

  const lightbox = document.getElementById('lightbox');
  const lbImg = document.getElementById('lbImg');
  const lbCap = document.getElementById('lbCap');
  const lbDown = document.getElementById('lbDown');
  const closeBtn = document.getElementById('closeBtn');

  document.body.addEventListener('click', (e) => {
    const card = e.target.closest('.card');
    if (!card) return;
    const src = card.dataset.src;
    const title = card.dataset.title || 'Preview';
    lbImg.src = src;
    lbImg.alt = title;
    lbCap.textContent = title;
    lbDown.href = src;
    lbDown.setAttribute('download', card.dataset.desc || (title + '.png'));
    lightbox.style.display = 'flex';
    lightbox.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
  });
  closeBtn.onclick = () => { lightbox.style.display='none'; lightbox.setAttribute('aria-hidden','true'); document.body.style.overflow='auto'; lbImg.src=''; };
  lightbox.addEventListener('click', e => { if (e.target === lightbox) closeBtn.onclick(); });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeBtn.onclick(); });

  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');

  uploadBtn.addEventListener('click', async () => {
    const files = fileInput.files;
    if (!files || files.length === 0) { alert('Choose files first'); return; }
    const fd = new FormData();
    for (let f of files) fd.append('files', f, f.name);
    const res = await fetch('/upload', { method: 'POST', body: fd });
    if (!res.ok) { alert('Upload failed'); return; }
    const data = await res.json();
    data.saved.forEach(fn => uploads.unshift(fn));
    renderLists();
    alert('Saved ' + data.saved.length + ' file(s) to uploads/');
    fileInput.value = '';
  });

  document.getElementById('downloadAll').addEventListener('click', () => {
    const all = dataset.concat(uploads);
    if (all.length === 0) { alert('No images'); return; }
    if (!confirm('This will open each image in a new tab for manual saving. Continue?')) return;
    all.forEach(fn => window.open(`/images/${fn}`, '_blank'));
  });
</script>
</body>
</html>
